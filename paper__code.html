
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML is auto-generated from an M-file.
To make changes, update the M-file and republish this document.
      --><title>paper__sys_parameter</title><meta name="generator" content="MATLAB 7.9"><meta name="date" content="2011-03-09"><meta name="m-file" content="paper__sys_parameter"><style type="text/css">

body {
  background-color: white;
  margin:10px;
}

h1 {
  color: #990000; 
  font-size: x-large;
}

h2 {
  color: #990000;
  font-size: medium;
}

/* Make the text shrink to fit narrow windows, but not stretch too far in 
wide windows. */ 
p,h1,h2,div.content div {
  max-width: 600px;
  /* Hack for IE6 */
  width: auto !important; width: 600px;
}

pre.codeinput {
  background: #EEEEEE;
  padding: 10px;
}
@media print {
  pre.codeinput {word-wrap:break-word; width:100%;}
} 

span.keyword {color: #0000FF}
span.comment {color: #228B22}
span.string {color: #A020F0}
span.untermstring {color: #B20000}
span.syscmd {color: #B28C00}

pre.codeoutput {
  color: #666666;
  padding: 10px;
}

pre.error {
  color: red;
}

p.footer {
  text-align: right;
  font-size: xx-small;
  font-weight: lighter;
  font-style: italic;
  color: gray;
}

  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#1">Adaptive Kalman Filtering with parameter estimation in NCS with Random Sensor Delays,Packet Dropouts and Missing Measurements.</a></li><li><a href="#2">System model matrices.</a></li><li><a href="#3">Controller Design</a></li><li><a href="#4">Initializations</a></li><li><a href="#5">Gradient initialization dxs=Gradient of xs(1/0)</a></li><li><a href="#6">Stchatic parameter for packet dropout</a></li><li><a href="#7">Coeff. matrices of the model with no uncertainty,one step sensor delay,missing mearsurements.</a></li><li><a href="#8">Filter algorithm for k&gt;0</a></li><li><a href="#9">Plotings</a></li><li><a href="#10">end</a></li></ul></div><h2>Adaptive Kalman Filtering with parameter estimation in NCS with Random Sensor Delays,Packet Dropouts and Missing Measurements.<a name="1"></a></h2><p>System Structure and Dimensions x(x+1)=A(th)x(k)+Bw(k)+gu(k)  ; Where A(th) is the continous function of unknown constant parameter th. y(k+1)=Cx(k+1)+v(k+1); A(2,2),B(2,1),g(2,1),C(1,2) and w(k),v(k),u(k) are scalar input.</p><pre class="codeinput">clear <span class="string">all</span>
</pre><h2>System model matrices.<a name="2"></a></h2><p>a=[.8 0;.9 .2]; a=[0 1;1e-5 .99998]; a=[0 0.0590;-0.0008 0.9672];</p><pre class="codeinput">a=[1.7240 -0.74383;1 0];
dA=a;
B=[1;.5];
dB=0;
g=[1;1];
dg=0;
C=[1 1];
dC=0;
Pw=1; Pv=.25;
bm=[0.6 1.4];
<span class="comment">% l=2.5;%for randon variable theta</span>
l=.3; <span class="comment">%for constant theta</span>
[n,m]=size(B);
r=[.8 .02 .09 .09];  <span class="comment">%probability for uncertain cases 1,2,3,4</span>
u=0;
du=0;
<span class="comment">% tht=ranumb(bm(1),bm(2),1,10000);</span>
tht(1:6000)=0.7;
tht(6001:12000)=1.3;
<span class="comment">% tht(4001:5000)=1;</span>
N=length(tht);
</pre><h2>Controller Design<a name="3"></a></h2><pre class="codeinput">[K,SHI]=dcontr122(a,bm,g)
<span class="comment">% [K1,K2]=dcontr123(a,bm,g)</span>
</pre><pre class="codeoutput">
 Solver for LMI feasibility problems L(x) &lt; R(x)
    This solver minimizes  t  subject to  L(x) &lt; R(x) + t*I
    The best value of t should be negative for feasibility

 Iteration   :    Best value of t so far 
 
     1                    5.036283e-004
     2                    5.036283e-004
     3                    5.865450e-005
     4                    5.865450e-005
     5                    2.753741e-005
     6                    2.753741e-005
     7                    8.341912e-006
     8                    8.341912e-006
     9                    8.341912e-006
    10                    2.463284e-006
    11                    2.463284e-006
    12                    9.310402e-007
    13                    9.310402e-007
    14                    9.310402e-007
    15                    4.712653e-007
    16                    4.712653e-007
    17                    1.971079e-007
    18                    1.971079e-007
    19                    1.236787e-007
    20                    1.236787e-007
    21                    6.234442e-008
    22                    6.234442e-008
    23                    2.654594e-008
    24                    -8.507385e-008

 Result:  best value of t: -8.507385e-008
          f-radius saturation:  0.000% of R = 1.00e+009
 

K =

    1.1841   -2.2214


SHI =

    2.8365    2.5585
    2.5585    2.3303

</pre><h2>Initializations<a name="4"></a></h2><pre class="codeinput">x=[2;2]; xs=zeros(n,1); th=1;
xa=zeros(n,100); xsa=zeros(n,100); tha=zeros(1,100); tr_e=zeros(1,100);
xa(:,1)=x;
Xs=[xs;xs];
y=0;
tha(1)=th;
F=[eye(2*n) zeros(2*n,1)];
T=[eye(n) zeros(n)];
p0=20*eye(n);
P=[p0 p0;p0 p0];<span class="comment">%initial error covariance of FX-Xs</span>
PW=[Pw zeros(m,1) zeros(m,1);zeros(1,m) Pv zeros(1);zeros(1,m) zeros(1) Pv];
w=ranum(.8191,0,sqrt(Pw),m,40000);  <span class="comment">%process noise</span>
v=ranum(.2047,0,sqrt(Pv),1,40000);  <span class="comment">%measurement noise</span>
vk_=v(:,1);
</pre><h2>Gradient initialization dxs=Gradient of xs(1/0)<a name="5"></a></h2><p>for k=0 to 1</p><pre class="codeinput">dxs=zeros(n,1);  <span class="comment">% diff. of xs(1/0) for all components of the theta.</span>
A=a*th;
dAs=[dA zeros(n);zeros(n) zeros(n)];
dP=zeros(2*n,2*n);
</pre><h2>Stchatic parameter for packet dropout<a name="6"></a></h2><pre class="codeinput"><span class="comment">%Representation of random packet dropout:0=packet droped and 1=packet arrived</span>
load <span class="string">packet</span>
pas=pas(2,:);
</pre><h2>Coeff. matrices of the model with no uncertainty,one step sensor delay,missing mearsurements.<a name="7"></a></h2><pre class="codeinput">B1=[B zeros(n,1) zeros(n,1);zeros(n,m) zeros(n,1) zeros(n,1);zeros(1,m) eye(1) zeros(1)];
B2=[B zeros(n,1) zeros(n,1);zeros(n,m) zeros(n,1) zeros(n,1);zeros(1,m) zeros(1) eye(1)];
B3=[B zeros(n,1) zeros(n,1);zeros(n,m) zeros(n,1) zeros(n,1);zeros(1,m) eye(1) zeros(1)];
C1=[C zeros(1,n) zeros(1)];
C2=[zeros(1,n) C zeros(1)];
C3=[zeros(1,n) zeros(1,n) zeros(1)];
I=[zeros(2*1,m) eye(2*1)];
H1=[eye(1) zeros(1)]*I;
H2=[zeros(1) eye(1)]*I;
H3=[eye(1) zeros(1)]*I;
piq=zeros(1,3);
<span class="keyword">for</span> q=1:3
    piq(q)=r(q)/sum(r(1:3));
<span class="keyword">end</span>
CS=piq(1)*C1+piq(2)*C2+piq(3)*C3;
HS=piq(1)*H1+piq(2)*H2+piq(3)*H3;
Cs=CS*F';
s1=piq(1)*F*B1*PW*B1'*F'+piq(2)*F*B2*PW*B2'*F'+piq(3)*F*B3*PW*B3'*F';
s2=piq(1)*H1*PW*H1'+piq(2)*H2*PW*H2'+piq(3)*H3*PW*H3';
</pre><h2>Filter algorithm for k&gt;0<a name="8"></a></h2><pre class="codeinput"><span class="keyword">for</span> k=1:N
    As=[A zeros(n);eye(n) zeros(n)];
    A0=a*tht(k);
    xk=A0*x+B*w(:,k)+g*u;
    X=[xk' x' y']';
    W=[w(:,k)' v(:,k)' vk_']';

    xsk=A*xs+g*u; <span class="comment">%One step prediction of state.</span>
    dxsk=dA*xs+A*dxs+g*du;
    Xs=[xsk' xs']';
    dXs=[dxsk' dxs']';

    <span class="comment">% Predicted covariance</span>
    dP=dAs*P*As'+As*dP*As'+As*P*dAs';
    P=As*P*As'+s1;

    <span class="keyword">if</span> pas(k)==0
        yk=y;
        Ls=zeros(n,1);
        dLs=zeros(n,1);
    <span class="keyword">else</span>
        yk=CS*X+HS*W;
        Ls=T*P*Cs'/(Cs*P*Cs'+s2); <span class="comment">% Gain calculation</span>
        dLs=T*dP*Cs'/(Cs*P*Cs'+s2)+(T*P*Cs'/(Cs*P*Cs'+s2))*Cs*dP*Cs'/(Cs*P*Cs'+s2);
    <span class="keyword">end</span>

    yn=yk-Cs*Xs;
    dyn=-Cs*dXs;
    xs=xsk+Ls*yn;   <span class="comment">% Updates state</span>
    dxs=dxsk+dLs*yn+Ls*dyn;

    <span class="comment">%Update of cov. and gradient of cov.</span>
    Rs=[Ls' zeros(1,n)]';
    dRs=[dLs' zeros(1,n)]';
    s3=piq(1)*Rs*H1*PW*H1'*Rs'+piq(2)*Rs*H2*PW*H2'*Rs'+piq(3)*Rs*H3*PW*H3'*Rs';
    dP=-dRs*Cs*P*(eye(2*n)-Rs*Cs)'-(eye(2*n)-Rs*Cs)*P*(dRs*Cs)'+(eye(2*n)-Rs*Cs)*dP*(eye(2*n)-Rs*Cs)'+dRs*s2*Rs'+Rs*s2*dRs';
    P=(eye(2*n)-Rs*Cs)*P*(eye(2*n)-Rs*Cs)'+s3;

    <span class="comment">% Parameter update</span>
    thp=th-l*dyn'*yn/k;
    <span class="keyword">if</span> thp&lt;bm(1)
       th=bm(1);
    <span class="keyword">else</span> <span class="keyword">if</span> thp&gt;bm(2)
            th=bm(2);
        <span class="keyword">else</span>
            th=thp;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    A=a*th; <span class="comment">%Update of the system matrix.</span>
    u=K*xs;
    du=K*dxs;
<span class="comment">%     eig(A+g*K)</span>

    <span class="comment">%Storing and updating the loop variables.</span>
    ek=T*P*T';
    tr_e(k)=trace(ek);

    y=yk;
    xa(:,k+1)=xk;
    x=xk;
    xsa(:,k+1)=xs;
    vk_=v(:,k);
    tha(k+1)=th;
<span class="keyword">end</span>
</pre><h2>Plotings<a name="9"></a></h2><pre class="codeinput">figure
<span class="keyword">for</span> i=1:n
    subplot(1,2,i)
    hold <span class="string">on</span>
    plot(xa(i,:),<span class="string">'b'</span>,<span class="string">'linewidth'</span>,1.5)
    plot(xsa(i,:),<span class="string">'r--'</span>,<span class="string">'linewidth'</span>,1.5)
    grid
    title([<span class="string">'signal x'</span>,int2str(i),<span class="string">' WITH CONTR."'</span>],<span class="string">'color'</span>,<span class="string">'b'</span>,<span class="string">'FontSize'</span>,12)
    xlabel(<span class="string">'time k'</span>,<span class="string">'FontSize'</span>,14)
    ylabel([<span class="string">'x'</span>,int2str(i)],<span class="string">'FontSize'</span>,14)
    legend(<span class="string">'Original state'</span>,<span class="string">'estimated state'</span>)
    hold <span class="string">off</span>
<span class="keyword">end</span>
    figure
<span class="comment">%     subplot(1,2,1)</span>
<span class="comment">%     plot(tr_e,'linewidth',1.5)</span>
<span class="comment">%     grid</span>
<span class="comment">%     title('Trace of error covariance')</span>
<span class="comment">%     xlabel('time k')</span>
<span class="comment">%     ylabel('K')</span>
<span class="comment">%</span>
<span class="comment">% subplot(1,2,2)</span>
hold <span class="string">on</span>
plot(tha,<span class="string">'r--'</span>,<span class="string">'linewidth'</span>,1.5)
plot(tht,<span class="string">'b'</span>)
legend(<span class="string">'Estimated theta'</span>,<span class="string">'True theta'</span>)
grid
title(<span class="string">'ESTIMATED PARAMETER WITH CONTR.'</span>)
xlabel(<span class="string">'time k'</span>)
ylabel(<span class="string">'theta(k)'</span>)
</pre><img vspace="5" hspace="5" src="paper__sys_parameter_01.png" alt=""> <img vspace="5" hspace="5" src="paper__sys_parameter_02.png" alt=""> <h2>end<a name="10"></a></h2><p class="footer"><br>
      Published with MATLAB&reg; 7.9<br></p></div><!--
##### SOURCE BEGIN #####
%% Adaptive Kalman Filtering with parameter estimation in NCS with Random Sensor Delays,Packet Dropouts and Missing Measurements.
% System Structure and Dimensions
% x(x+1)=A(th)x(k)+Bw(k)+gu(k)  ; Where A(th) is the continous function of unknown constant parameter th.
% y(k+1)=Cx(k+1)+v(k+1); A(2,2),B(2,1),g(2,1),C(1,2) and w(k),v(k),u(k) are scalar input.
clear all
%% System model matrices.
% a=[.8 0;.9 .2];
% a=[0 1;1e-5 .99998];
% a=[0 0.0590;-0.0008 0.9672];
a=[1.7240 -0.74383;1 0];
dA=a;
B=[1;.5];
dB=0;
g=[1;1];
dg=0;
C=[1 1];
dC=0;
Pw=1; Pv=.25;
bm=[0.6 1.4];
% l=2.5;%for randon variable theta
l=.3; %for constant theta
[n,m]=size(B);
r=[.8 .02 .09 .09];  %probability for uncertain cases 1,2,3,4
u=0;
du=0;
% tht=ranumb(bm(1),bm(2),1,10000);
tht(1:6000)=0.7;
tht(6001:12000)=1.3;
% tht(4001:5000)=1;
N=length(tht);
%% Controller Design
[K,SHI]=dcontr122(a,bm,g)
% [K1,K2]=dcontr123(a,bm,g)
%% Initializations
x=[2;2]; xs=zeros(n,1); th=1;
xa=zeros(n,100); xsa=zeros(n,100); tha=zeros(1,100); tr_e=zeros(1,100);
xa(:,1)=x;
Xs=[xs;xs];
y=0;
tha(1)=th;
F=[eye(2*n) zeros(2*n,1)];
T=[eye(n) zeros(n)];
p0=20*eye(n);
P=[p0 p0;p0 p0];%initial error covariance of FX-Xs
PW=[Pw zeros(m,1) zeros(m,1);zeros(1,m) Pv zeros(1);zeros(1,m) zeros(1) Pv];
w=ranum(.8191,0,sqrt(Pw),m,40000);  %process noise
v=ranum(.2047,0,sqrt(Pv),1,40000);  %measurement noise
vk_=v(:,1);
%% Gradient initialization dxs=Gradient of xs(1/0)
% for k=0 to 1
dxs=zeros(n,1);  % diff. of xs(1/0) for all components of the theta.
A=a*th;
dAs=[dA zeros(n);zeros(n) zeros(n)];
dP=zeros(2*n,2*n);
%% Stchatic parameter for packet dropout
%Representation of random packet dropout:0=packet droped and 1=packet arrived
load packet
pas=pas(2,:);
%% Coeff. matrices of the model with no uncertainty,one step sensor delay,missing mearsurements.
B1=[B zeros(n,1) zeros(n,1);zeros(n,m) zeros(n,1) zeros(n,1);zeros(1,m) eye(1) zeros(1)];
B2=[B zeros(n,1) zeros(n,1);zeros(n,m) zeros(n,1) zeros(n,1);zeros(1,m) zeros(1) eye(1)];
B3=[B zeros(n,1) zeros(n,1);zeros(n,m) zeros(n,1) zeros(n,1);zeros(1,m) eye(1) zeros(1)];
C1=[C zeros(1,n) zeros(1)];
C2=[zeros(1,n) C zeros(1)];
C3=[zeros(1,n) zeros(1,n) zeros(1)];
I=[zeros(2*1,m) eye(2*1)];
H1=[eye(1) zeros(1)]*I;
H2=[zeros(1) eye(1)]*I;
H3=[eye(1) zeros(1)]*I;
piq=zeros(1,3);
for q=1:3
    piq(q)=r(q)/sum(r(1:3));
end
CS=piq(1)*C1+piq(2)*C2+piq(3)*C3;
HS=piq(1)*H1+piq(2)*H2+piq(3)*H3;
Cs=CS*F';
s1=piq(1)*F*B1*PW*B1'*F'+piq(2)*F*B2*PW*B2'*F'+piq(3)*F*B3*PW*B3'*F';
s2=piq(1)*H1*PW*H1'+piq(2)*H2*PW*H2'+piq(3)*H3*PW*H3';
%% Filter algorithm for k>0
for k=1:N
    As=[A zeros(n);eye(n) zeros(n)];
    A0=a*tht(k);
    xk=A0*x+B*w(:,k)+g*u;
    X=[xk' x' y']';
    W=[w(:,k)' v(:,k)' vk_']';
    
    xsk=A*xs+g*u; %One step prediction of state.
    dxsk=dA*xs+A*dxs+g*du;
    Xs=[xsk' xs']';
    dXs=[dxsk' dxs']';
    
    % Predicted covariance
    dP=dAs*P*As'+As*dP*As'+As*P*dAs';
    P=As*P*As'+s1;
    
    if pas(k)==0
        yk=y;
        Ls=zeros(n,1);
        dLs=zeros(n,1);
    else
        yk=CS*X+HS*W;
        Ls=T*P*Cs'/(Cs*P*Cs'+s2); % Gain calculation
        dLs=T*dP*Cs'/(Cs*P*Cs'+s2)+(T*P*Cs'/(Cs*P*Cs'+s2))*Cs*dP*Cs'/(Cs*P*Cs'+s2);
    end
    
    yn=yk-Cs*Xs;
    dyn=-Cs*dXs;
    xs=xsk+Ls*yn;   % Updates state
    dxs=dxsk+dLs*yn+Ls*dyn;
    
    %Update of cov. and gradient of cov.
    Rs=[Ls' zeros(1,n)]';
    dRs=[dLs' zeros(1,n)]';
    s3=piq(1)*Rs*H1*PW*H1'*Rs'+piq(2)*Rs*H2*PW*H2'*Rs'+piq(3)*Rs*H3*PW*H3'*Rs';
    dP=-dRs*Cs*P*(eye(2*n)-Rs*Cs)'-(eye(2*n)-Rs*Cs)*P*(dRs*Cs)'+(eye(2*n)-Rs*Cs)*dP*(eye(2*n)-Rs*Cs)'+dRs*s2*Rs'+Rs*s2*dRs';
    P=(eye(2*n)-Rs*Cs)*P*(eye(2*n)-Rs*Cs)'+s3;

    % Parameter update
    thp=th-l*dyn'*yn/k;
    if thp<bm(1)
       th=bm(1);
    else if thp>bm(2)
            th=bm(2);
        else
            th=thp;
        end
    end
    A=a*th; %Update of the system matrix.
    u=K*xs;
    du=K*dxs;
%     eig(A+g*K)
    
    %Storing and updating the loop variables.
    ek=T*P*T';
    tr_e(k)=trace(ek);
    
    y=yk;
    xa(:,k+1)=xk;
    x=xk;
    xsa(:,k+1)=xs;
    vk_=v(:,k);
    tha(k+1)=th;
end
%% Plotings
figure
for i=1:n
    subplot(1,2,i)
    hold on
    plot(xa(i,:),'b','linewidth',1.5)
    plot(xsa(i,:),'rREPLACE_WITH_DASH_DASH','linewidth',1.5)
    grid
    title(['signal x',int2str(i),' WITH CONTR."'],'color','b','FontSize',12)
    xlabel('time k','FontSize',14)
    ylabel(['x',int2str(i)],'FontSize',14)
    legend('Original state','estimated state')
    hold off
end
    figure
%     subplot(1,2,1)
%     plot(tr_e,'linewidth',1.5)
%     grid
%     title('Trace of error covariance')
%     xlabel('time k')
%     ylabel('K')
% 
% subplot(1,2,2)
hold on
plot(tha,'rREPLACE_WITH_DASH_DASH','linewidth',1.5)
plot(tht,'b')
legend('Estimated theta','True theta')
grid
title('ESTIMATED PARAMETER WITH CONTR.')
xlabel('time k')
ylabel('theta(k)')
%% end

##### SOURCE END #####
--></body></html>